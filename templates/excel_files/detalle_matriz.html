{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}
{{ matriz.nombre }}
{% endblock title %}

{% block content %}
{% include 'includes/header.html' %}
<div class="container">

    <h2 class="mb-3">{{ matriz.nombre }}</h2>

    {% if alcances_lista %}
        <p>Filtros usados:</p>
        <ul>
        {% for alcance in alcances_lista %}
            {% if alcance == "A" %}
                Minimum Viable Product 
            {% elif alcance == "B" %}
                SMOKE TEST
            {% elif alcance == "C" %}
                No Afectaci√≥n
            {% endif %}
            <br>
        {% endfor %}
        </ul>
    {% else %}
        <p>No hay filtros aplicados.</p>
    {% endif %}

    <h4 class="mt-4">Filtrar por tester:</h4>
    <ul class="list-inline">
        <li class="list-inline-item">
            <a href="{% url 'matrix_app:detalle_matriz' matriz.id %}" class="btn btn-outline-primary btn-sm">Todos</a>
        </li>
        {% for tester in testers_disponibles %}
            <li class="list-inline-item">
                <a href="{% url 'matrix_app:detalle_matriz' matriz.id %}?tester={{ tester }}"
                   class="btn btn-outline-secondary btn-sm {% if tester == tester_filtrado %}active{% endif %}">
                    {{ tester }}
                </a>
            </li>
        {% endfor %}
    </ul>

    <p class="text-muted mt-3">Editar los estados y notas de los casos de prueba.</p>

    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th class="col-fase">Fase</th>
                <th class="col-caso">Caso de Prueba</th>
                <th class="col-estado">Estado</th>
                <th class="col-criticidad">Criticidad</th>
                <th class="col-nota">Nota</th>
            </tr>
        </thead>
        <tbody>
            {% for caso, form in formularios_casos_de_prueba %}
                <tr data-id="{{ caso.id }}">
                    <td>{{ caso.fase }}</td>
                    <td>{{ caso.caso_de_prueba }}</td>
                    <td>{% render_field form.estado class="estado-input form-control" %}</td>
                    <td>    
                        {% if caso.criticidad|lower == "bloqueante" %}
                            <span class="badge bg-danger">üî∂ Bloqueante</span>
                        {% elif caso.criticidad|lower == "critico" or caso.criticidad|lower == "cr√≠tico" %}
                            <span class="badge bg-warning text-dark">üü° Cr√≠tico</span>
                        {% elif caso.criticidad|lower == "error" %}
                            <span class="badge bg-danger">üî¥ Error</span>
                        {% else %}
                            <span class="badge bg-secondary">Sin clasificar</span>
                        {% endif %}
                    </td>
                    <td>{% render_field form.nota class="nota-input form-control" %}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="sticky-action-bar">
        <!--<button type="button" class="btn btn-success" onclick="guardarCambios()">üíæ Guardar</button>-->
        <a href="{% url 'matrix_app:detalle_super_matriz' super_matriz_id %}" class="btn btn-secondary">‚Üê Volver</a>
    </div>

    <div id="mensaje" class="alert alert-success d-none alert-position" role="alert">
        Cambios guardados correctamente.
    </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {
    // 1) Colorea el <select> seg√∫n estado
    function actualizarColor(select) {
        const valor = select.value;
        select.classList.remove(
            'estado-funciona','estado-falla-nueva','estado-falla-persistente',
            'estado-na','estado-pendiente','estado-por-ejecutar'
        );
        switch (valor) {
            case 'funciona':           select.classList.add('estado-funciona'); break;
            case 'falla_nueva':        select.classList.add('estado-falla-nueva'); break;
            case 'falla_persistente':  select.classList.add('estado-falla-persistente'); break;
            case 'na':                 select.classList.add('estado-na'); break;
            case 'pendiente':          select.classList.add('estado-pendiente'); break;
            case 'por_ejecutar':       select.classList.add('estado-por-ejecutar'); break;
        }
    }

    // 2) Al cambiar un estado (o nota), marca dirty, recolorea, guarda y recarga
    document.querySelectorAll('.validate-estado').forEach(select => {
        actualizarColor(select);
        select.addEventListener('change', function () {
            const tr = this.closest('tr');
            tr.dataset.dirty = "true";
            actualizarColor(this);
            console.log("üü° Fila marcada y auto-guardando:", tr.dataset.id);
            guardarValidates();           // dispara el POST
            window.location.reload();     // recarga inmediata
        });
    });

    // 3) Funci√≥n de guardado parcial
    window.guardarValidates = async function () {
        const filas = Array.from(document.querySelectorAll('tr[data-dirty="true"]'));
        if (!filas.length) return;

        const cambios = filas.map(tr => ({
            id: tr.dataset.id,
            estado: tr.querySelector('.validate-estado').value
        }));

        console.log("üì§ Enviando validates:", cambios);
        try {
            const resp = await fetch("/matrix/api/guardar-validates/", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ registros: cambios })
            });
            const data = await resp.json();
            if (data.status === 'ok') {
                filas.forEach(tr => delete tr.dataset.dirty);
                const msg = document.getElementById('auto-save-msg');
                msg.style.display = 'inline';
                setTimeout(() => msg.style.display = 'none', 3000);
            } else {
                console.error('Error guardando:', data.error);
            }
        } catch (e) {
            console.error('Fetch error:', e);
        }
    };

    // 4) Auto‚Äêsave cada 30 segundos
    setInterval(guardarValidates, 30 * 1000);

    // 5) (Opcional) Auto‚Äêreload cada 60 segundos
    setInterval(() => {
        console.log("‚è∞ Recargando para captar cambios externos‚Ä¶");
        window.location.reload();
    }, 60 * 1000);

    // ‚Äî Helpers ‚Äî
    function getCookie(name) {
        let value = null;
        document.cookie.split(';').forEach(c => {
            c = c.trim();
            if (c.startsWith(name + '=')) {
                value = decodeURIComponent(c.split('=')[1]);
            }
        });
        return value;
    }
});
</script>



{% endblock content %}
