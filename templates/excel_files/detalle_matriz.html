{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}
{{ matriz.nombre }}
{% endblock title %}

{% block content %}
{% include 'includes/header.html' %}

<div class="container">
    <h2 class="mb-3">{{ matriz.nombre }}</h2>

    {% if alcances_lista %}
        <p>Filtros usados:</p>
        <ul>
        {% for alcance in alcances_lista %}
            {% if alcance == "A" %}
                <li>Minimum Viable Product</li>
            {% elif alcance == "B" %}
                <li>SMOKE TEST</li>
            {% elif alcance == "C" %}
                <li>No Afectaci√≥n</li>
            {% endif %}
        {% endfor %}
        </ul>
    {% else %}
        <p>No hay filtros aplicados.</p>
    {% endif %}

    <h4 class="mt-4">Filtrar por tester:</h4>
    <ul class="list-inline">
        <li class="list-inline-item">
            <a href="{% url 'matrix_app:detalle_matriz' matriz.id %}" class="btn btn-outline-primary btn-sm">Todos</a>
        </li>
        {% for tester in testers_disponibles %}
            <li class="list-inline-item">
                <a href="{% url 'matrix_app:detalle_matriz' matriz.id %}?tester={{ tester }}"
                   class="btn btn-outline-secondary btn-sm {% if tester == tester_filtrado %}active{% endif %}">
                    {{ tester }}
                </a>
            </li>
        {% endfor %}
    </ul>

    <p class="text-muted mt-3">Cambiar el estado o nota actualiza autom√°ticamente para todos los usuarios conectados.</p>

    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th class="col-fase">Fase</th>
                <th class="col-caso">Caso de Prueba</th>
                <th class="col-estado">Estado</th>
                <th class="col-criticidad">Criticidad</th>
                <th class="col-nota">Nota</th>
            </tr>
        </thead>
        <tbody>
            {% for caso, form in formularios_casos_de_prueba %}
                <tr data-id="{{ caso.id }}">
                    <td>{{ caso.fase }}</td>
                    <td>{{ caso.caso_de_prueba }}</td>
                    <td id="estado-caso-{{ caso.id }}">
                        {% render_field form.estado class="estado-input form-control" %}
                    </td>
                    <td>
                        {% if caso.criticidad|lower == "bloqueante" %}
                            <span class="badge bg-danger">üî∂ Bloqueante</span>
                        {% elif caso.criticidad|lower == "critico" or caso.criticidad|lower == "cr√≠tico" %}
                            <span class="badge bg-warning text-dark">üü° Cr√≠tico</span>
                        {% elif caso.criticidad|lower == "error" %}
                            <span class="badge bg-danger">üî¥ Error</span>
                        {% else %}
                            <span class="badge bg-secondary">Sin clasificar</span>
                        {% endif %}
                    </td>
                    <td id="nota-caso-{{ caso.id }}">
                        {% render_field form.nota class="nota-input form-control" %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <div class="sticky-action-bar">
        <a href="{% url 'matrix_app:detalle_super_matriz' super_matriz_id %}" class="btn btn-secondary">‚Üê Volver</a>
    </div>
</div>

<script>
    const matrizId = "{{ matriz.id }}";
    const socket = new WebSocket("ws://" + window.location.host + "/ws/matriz/" + matrizId + "/");

    socket.onopen = () => console.log("WebSocket conectado.");
    socket.onerror = e => console.error("WebSocket error:", e);

    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const casoId = data.caso_id;

        if (data.tipo === 'estado') {
            const nuevoEstado = data.valor;
            const celdaEstado = document.querySelector(`#estado-caso-${casoId}`);
            if (celdaEstado) {
                const select = celdaEstado.querySelector('select');
                if (select && select.value !== nuevoEstado) {
                    select.value = nuevoEstado;
                    aplicarColorEstado(select);
                    select.classList.add("flash-update");
                    setTimeout(() => select.classList.remove("flash-update"), 1500);
                }
            }
        }

        if (data.tipo === 'nota') {
            const nuevaNota = data.valor;
            const celdaNota = document.querySelector(`#nota-caso-${casoId}`);
            if (celdaNota) {
                const input = celdaNota.querySelector('input');
                if (input && input.value !== nuevaNota) {
                    input.value = nuevaNota;
                    input.classList.add("flash-update");
                    setTimeout(() => input.classList.remove("flash-update"), 1500);
                }
            }
        }
    };

    document.querySelectorAll('.estado-input').forEach(select => {
        aplicarColorEstado(select);
        select.addEventListener('change', function () {
            const casoId = this.closest('tr').dataset.id;
            const nuevoEstado = this.value;

            fetch("{% url 'matrix_app:actualizar_estado_caso' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `caso_id=${casoId}&nuevo_estado=${nuevoEstado}`
            });

            aplicarColorEstado(this);
        });
    });

    document.querySelectorAll('.nota-input').forEach(input => {
        input.addEventListener('blur', function () {
            const casoId = this.closest('tr').dataset.id;
            const nuevaNota = this.value;

            fetch("{% url 'matrix_app:actualizar_nota_caso' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `caso_id=${casoId}&nota=${encodeURIComponent(nuevaNota)}`
            });
        });
    });

    function aplicarColorEstado(select) {
        const estado = select.value.toLowerCase().trim();
        select.className = "estado-input form-control";

        if (estado === "funciona") {
            select.classList.add("bg-success", "text-white");
        } else if (estado === "falla_nueva") {
            select.classList.add("bg-danger", "text-white");
        } else if (estado === "falla_persistente") {
            select.style.backgroundColor = "#ef9a9a";
            select.style.color = "#000";
        } else if (estado === "n/a") {
            select.classList.add("bg-secondary", "text-dark");
        } else if (estado === "pendiente") {
            select.style.backgroundColor = "#ffcc80";
            select.style.color = "#000";
        } else if (estado === "por_ejecutar") {
            select.classList.add("bg-warning", "text-dark");
        } else {
            select.style.backgroundColor = "#90caf9";
            select.style.color = "#000";
        }

        select.style.padding = "8px 14px";
        select.style.height = "40px";
        select.style.fontWeight = "bold";
    }
</script>

<style>
.flash-update {
    background-color: #fff3cd !important;
    transition: background-color 1s ease;
}
</style>


{% endblock content %}

<!-- <script>
document.addEventListener("DOMContentLoaded", function () {
    // 1) Funci√≥n para colorear seg√∫n estado
    function aplicarColorEstado(select) {
        const valor = select.value.toLowerCase();
        select.classList.remove("bg-success","bg-warning","bg-danger","bg-secondary","text-white","text-dark");
        if (valor === "completado" || valor.includes("funcio")) {
            select.classList.add("bg-success","text-white");
        } else if (valor.includes("por") || valor.includes("pendient")) {
            select.classList.add("bg-warning","text-dark");
        } else if (valor.includes("falla") || valor.includes("error")) {
            select.classList.add("bg-danger","text-white");
        } else {
            select.classList.add("bg-secondary","text-white");
        }
    }

    // 2) Cuando cambie estado o nota: marcar dirty, recolorear y guardar
    document.querySelectorAll('.estado-input, .nota-input').forEach(input => {
        if (input.classList.contains('estado-input')) {
            aplicarColorEstado(input);
        }
        input.addEventListener('change', function () {
            const tr = this.closest('tr');
            tr.dataset.dirty = "true";
            if (this.classList.contains('estado-input')) {
                aplicarColorEstado(this);
            }
            console.log("üü° Fila marcada y auto-guardando:", tr.dataset.id);
            guardarCambios();
            window.location.reload();
            
        });
    });

    // 3) Funci√≥n de guardado parcial
    window.guardarCambios = function () {
        const filas = Array.from(document.querySelectorAll("tr[data-dirty='true']"));
        if (!filas.length) return;  // nada que enviar

        const cambios = filas.map(tr => ({
            id: tr.dataset.id,
            estado: tr.querySelector(".estado-input").value,
            nota: tr.querySelector(".nota-input").value
        }));
        console.log("üì§ Enviando cambios:", cambios);

        fetch("/matrix/api/guardar-estado/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")
            },
            body: JSON.stringify({ registros: cambios })
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === "ok") {
                filas.forEach(tr => delete tr.dataset.dirty);
                mostrarMensaje("Cambios guardados correctamente.", "success");
            } else {
                mostrarMensaje("Error al guardar: " + data.error, "danger");
            }
        })
        .catch(err => {
            console.error("üí• Error de red:", err);
            mostrarMensaje("Error de red al guardar.", "danger");
        });
    };

    // 4) Auto-save cada 2 minutos (120 000 ms)
    setInterval(guardarCambios, 2 * 60 * 1000);

    // 5) Auto-reload cada 1 minuto (60 000 ms)
    setInterval(() => {
        console.log("‚è∞ Recargando la p√°gina para obtener cambios‚Ä¶");
        window.location.reload();
    }, 60 * 1000);

    // ‚Äî Helpers ‚Äî
    function getCookie(name) {
        let v = null;
        document.cookie.split(';').forEach(c => {
            c = c.trim();
            if (c.startsWith(name + '=')) {
                v = decodeURIComponent(c.split('=')[1]);
            }
        });
        return v;
    }
    function mostrarMensaje(texto, tipo) {
        const msg = document.getElementById("mensaje");
        msg.className = `alert alert-${tipo} alert-position`;
        msg.innerText = texto;
        msg.classList.remove("d-none");
        setTimeout(() => msg.classList.add("d-none"), 3000);
    }
});
</script> -->
