{% extends 'base.html' %}
{% load static %}

{% block title %}
Validates ‚Äì {{ super_matriz.nombre }}
{% endblock title %}

{% block content %}
{% include 'includes/header.html' %}
<div class="container py-3">
    {% if detalles_validate %}
    <div class="mb-4 p-3 border rounded bg-light">
        <h5 class="mb-2">üìù Detalles RN</h5>
        <p><strong>Filtro RN:</strong> {{ detalles_validate.filtro_RN }}</p>
        <p><strong>Comentario RN:</strong> {{ detalles_validate.comentario_RN }}</p>
    </div>
    {% endif %}

    <!-- Barra sticky con botones -->
    <div class="sticky-top d-flex justify-content-start align-items-center gap-2 p-2" 
         style="z-index: 1100; width: 40%;">
        <a href="{% url 'matrix_app:detalle_super_matriz' super_matriz.id %}" 
           class="btn btn-secondary btn-sm">‚¨Ö Volver</a>
        <!-- <button type="button" class="btn btn-success btn-sm" onclick="guardarValidates()"> 
            üíæ Guardar cambios-->
        </button>
        <span id="auto-save-msg" class="text-success small ms-3" style="display:none;">
            Guardado autom√°ticamente ‚úîÔ∏è
        </span>
    </div>

    <h1 class="mb-4 mt-3">Editar Validates</h1>

    <!-- Botones de filtro por testers -->
    <div class="mb-4">
        <button class="btn btn-primary btn-sm filter-btn active me-1 mb-2" data-tester="all">
            Todos
        </button>
        {% for tester in testers %}
          <button class="btn btn-outline-primary btn-sm filter-btn me-1 mb-2" 
                  data-tester="{{ tester|escape }}">
            {{ tester }}
          </button>
        {% empty %}
          <p class="text-muted">No hay testers disponibles.</p>
        {% endfor %}
    </div>

    <form id="validates-form" method="post" 
          action="{% url 'matrix_app:editar_validates' super_matriz.id %}">
        {% csrf_token %}
        <div class="table-responsive">
            <table id="validates-table" 
                   class="table table-bordered table-hover table-sm align-middle" 
                   style="font-size:0.9rem;">
                <thead class="table-light">
                    <tr>
                        <th style="width:20%;">Tester</th>
                        <th style="width:15%;">Ticket</th>
                        <th style="width:30%;">Descripci√≥n</th>
                        <th style="width:20%;">Prioridad</th>
                        <th style="width:15%;">Estado</th>
                    </tr>
                </thead>
                <tbody>
                {% for validate, form in formularios_validates %}
                    <tr data-id="{{ validate.id }}" data-tester="{{ validate.tester|escape }}">
                        <td style="width:20%;">{{ validate.tester }}</td>
                        <td style="width:15%;">
                            <a href="https://dlatvarg.atlassian.net/browse/{{ validate.ticket }}" 
                               target="_blank" class="text-decoration-none">
                                {{ validate.ticket }}
                            </a>
                        </td>
                        <td style="width:30%; white-space:pre-wrap;">
                            {{ validate.descripcion }}
                        </td>
                        <td style="width:20%;">{{ validate.prioridad }}</td>
                        <td style="width:15%;">{{ form.estado }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </form>
</div>

<style>
/* Colores para los estados */
.estado-funciona          { background-color:#d4edda!important; color:#155724!important; }
.estado-falla-nueva       { background-color:#c82333!important; color:#fff!important; }
.estado-falla-persistente { background-color:#f8d7da!important; color:#721c24!important; }
.estado-na                { background-color:#e2e3e5!important; color:#004085!important; }
.estado-pendiente         { background-color:#fd7e14!important; color:#fff!important; }
.estado-por-ejecutar      { background-color:#ffeeba!important; color:#856404!important; }

/* Botones filtro testers */
.filter-btn.active {
    background-color:#0d6efd!important;
    color:#fff!important;
    border-color:#0d6efd!important;
}

/* Tabla compacta */
#validates-table tbody tr td select.form-select {
    font-size:0.875rem;
    padding:0.25rem 0.5rem;
    height:28px;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // 1) Funci√≥n para colorear selects seg√∫n estado
    function actualizarColor(select) {
        const v = select.value.toLowerCase();
        select.classList.remove(
            'estado-funciona','estado-falla-nueva','estado-falla-persistente',
            'estado-na','estado-pendiente','estado-por-ejecutar'
        );
        if (v === 'funciona')           select.classList.add('estado-funciona');
        else if (v === 'falla_nueva')   select.classList.add('estado-falla-nueva');
        else if (v === 'falla_persistente') select.classList.add('estado-falla-persistente');
        else if (v === 'na')            select.classList.add('estado-na');
        else if (v === 'pendiente')     select.classList.add('estado-pendiente');
        else if (v === 'por_ejecutar')  select.classList.add('estado-por-ejecutar');
    }

    // 2) Al cambiar un select: marcar dirty, recolorear, auto‚Äêguardar y recargar
    document.querySelectorAll('.validate-estado').forEach(select => {
        actualizarColor(select);
        select.addEventListener('change', function () {
            const tr = this.closest('tr');
            tr.dataset.dirty = "true";
            actualizarColor(this);
            guardarValidates();       // guarda solo esta fila
            window.location.reload(); // recarga para reflejar todo
        });
    });

    // 3) Funci√≥n de guardado parcial
    window.guardarValidates = async function () {
        const filas = Array.from(document.querySelectorAll('tr[data-dirty="true"]'));
        if (!filas.length) return;
        const cambios = filas.map(tr => ({
            id: tr.dataset.id,
            estado: tr.querySelector('.validate-estado').value
        }));
        try {
            const resp = await fetch("/matrix/api/guardar-validates/", {
                method: 'POST',
                headers: {
                    'Content-Type':'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ registros: cambios })
            });
            const data = await resp.json();
            if (data.status === 'ok') {
                filas.forEach(tr => delete tr.dataset.dirty);
                const msg = document.getElementById('auto-save-msg');
                msg.style.display = 'inline';
                setTimeout(() => msg.style.display='none', 3000);
            } else {
                console.error('Error guardando:', data.error);
            }
        } catch (e) {
            console.error('Fetch error:', e);
        }
    };

    // 4) Auto‚Äêsave cada 30 s
    setInterval(guardarValidates, 30 * 1000);

    // 5) Auto‚Äêreload cada 60 s
    setInterval(() => {
        console.log("‚è∞ Recargando para captar cambios externos‚Ä¶");
        window.location.reload();
    }, 60 * 1000);

    // 6) Filtro por tester con persistencia en URL
    const filterButtons = document.querySelectorAll('.filter-btn');
    const rows = document.querySelectorAll('#validates-table tbody tr');
    filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            filterButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const tester = btn.dataset.tester;
            rows.forEach(r => {
                r.style.display = (tester==='all' || r.dataset.tester===tester) ? '' : 'none';
            });
            const url = new URL(window.location);
            if (tester==='all') url.searchParams.delete('tester');
            else url.searchParams.set('tester', tester);
            history.replaceState(null, '', url);
        });
    });
    // Al cargar, reaplicar filtro desde URL
    (function reaplicarFiltro(){
        const p = new URLSearchParams(window.location.search).get('tester');
        if (p) {
            const btn = document.querySelector(`.filter-btn[data-tester="${p}"]`);
            if (btn) btn.click();
        } else {
            document.querySelector('.filter-btn[data-tester="all"]').click();
        }
    })();

    // ‚Äî Helpers ‚Äî
    function getCookie(name) {
        let v = null;
        document.cookie.split(';').forEach(c=>{
            c = c.trim();
            if (c.startsWith(name+'=')) v = decodeURIComponent(c.slice(name.length+1));
        });
        return v;
    }
});
</script>


{% endblock content %}

